import pymysql
from pymysql.cursors import DictCursor
import time
import socket
import traceback
from passlib.context import CryptContext
import sys


class MySQLDatabase:
    def __init__(self, host, port, user, password, database, max_retries=3):
        """åˆå§‹åŒ–æ•°æ®åº“è¿æ¥å‚æ•°"""
        self.host = host
        self.port = port
        self.user = user
        self.password = password
        self.database = database
        self.connection = None
        self.max_retries = max_retries  # æœ€å¤§é‡è¯•æ¬¡æ•°
        self._check_dependencies()  # æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…

    def _check_dependencies(self):
        """æ£€æŸ¥å¿…è¦ä¾èµ–æ˜¯å¦å®‰è£…"""
        try:
            import bcrypt
        except ImportError:
            print("âš ï¸ è­¦å‘Š: æœªæ£€æµ‹åˆ°bcryptåº“ï¼Œå°è¯•è‡ªåŠ¨å®‰è£…...")
            try:
                import subprocess
                subprocess.check_call(
                    [sys.executable, "-m", "pip", "install", "bcrypt"]
                )
                print("âœ… bcryptåº“å®‰è£…æˆåŠŸ")
            except Exception as e:
                print(f"âŒ è‡ªåŠ¨å®‰è£…bcryptå¤±è´¥: {str(e)}")
                print("è¯·æ‰‹åŠ¨æ‰§è¡Œ: pip install bcrypt")

    def connect(self):
        """å»ºç«‹æ•°æ®åº“è¿æ¥ï¼Œå¸¦é‡è¯•æœºåˆ¶"""
        retry_count = 0
        while retry_count < self.max_retries:
            try:
                # å…ˆæ£€æŸ¥ç½‘ç»œè¿æ¥
                self._check_network()

                self.connection = pymysql.connect(
                    host=self.host,
                    port=self.port,
                    user=self.user,
                    password=self.password,
                    database=self.database,
                    charset='utf8mb4',
                    cursorclass=DictCursor,
                    connect_timeout=10,  # è¿æ¥è¶…æ—¶æ—¶é—´(ç§’)
                    autocommit=False  # æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡
                )
                print("âœ… æˆåŠŸè¿æ¥åˆ°æ•°æ®åº“ï¼")
                return True
            except pymysql.MySQLError as e:
                retry_count += 1
                error_msg = self._interpret_error(e)
                print(f"âŒ è¿æ¥æ•°æ®åº“å¤±è´¥ ({retry_count}/{self.max_retries}): {error_msg}")
                print(f"é”™è¯¯è¯¦æƒ…: {str(e)}")

                if retry_count < self.max_retries:
                    sleep_time = min(5, retry_count * 2)  # æœ€å¤šç­‰å¾…5ç§’
                    print(f"â³ {sleep_time}ç§’åé‡è¯•...")
                    time.sleep(sleep_time)
            except Exception as e:
                print(f"âŒ è¿æ¥è¿‡ç¨‹å‘ç”Ÿæ„å¤–é”™è¯¯: {str(e)}")
                return False
        return False

    def _check_network(self):
        """æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦é€šç•…"""
        try:
            # æµ‹è¯•ä¸æ•°æ®åº“æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥
            with socket.create_connection((self.host, self.port), timeout=5):
                return True
        except socket.timeout:
            raise Exception(f"ç½‘ç»œè¶…æ—¶: æ— æ³•åœ¨5ç§’å†…è¿æ¥åˆ° {self.host}:{self.port}")
        except socket.gaierror:
            raise Exception(f"åŸŸåè§£æå¤±è´¥: æ— æ³•è§£æä¸»æœºå '{self.host}'")
        except socket.error as e:
            raise Exception(f"ç½‘ç»œè¿æ¥å¤±è´¥: {str(e)}")

    def _interpret_error(self, error):
        """è§£ææ•°æ®åº“é”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º"""
        error_code = error.args[0] if error.args else 0

        error_map = {
            1045: "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·æ£€æŸ¥è®¤è¯ä¿¡æ¯",
            1049: f"æ•°æ®åº“ '{self.database}' ä¸å­˜åœ¨",
            2003: f"æ— æ³•è¿æ¥åˆ° {self.host}:{self.port}ï¼Œå¯èƒ½æ˜¯æœåŠ¡æœªå¯åŠ¨æˆ–ç«¯å£è¢«é˜²ç«å¢™æ‹¦æˆª",
            2005: f"æ— æ³•è§£æä¸»æœºå '{self.host}'ï¼Œè¯·æ£€æŸ¥IPåœ°å€æ˜¯å¦æ­£ç¡®",
            1044: f"ç”¨æˆ· '{self.user}' æ²¡æœ‰è®¿é—®æ•°æ®åº“ '{self.database}' çš„æƒé™",
            1062: "æ•°æ®é‡å¤ï¼Œè¿åå”¯ä¸€çº¦æŸï¼ˆç”¨æˆ·åå·²å­˜åœ¨ï¼‰",
            1146: "è¡¨ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è¡¨ç»“æ„",
            2013: "è¿æ¥è¶…æ—¶ï¼Œå¯èƒ½æ˜¯æ•°æ®åº“è´Ÿè½½è¿‡é«˜æˆ–ç½‘ç»œä¸ç¨³å®š",
            1364: "å­—æ®µæ²¡æœ‰é»˜è®¤å€¼ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æœ‰æœªæä¾›çš„å¿…å¡«å­—æ®µ",
            1054: "æœªçŸ¥çš„åˆ—åï¼Œè¯·æ£€æŸ¥è¡¨ç»“æ„æ˜¯å¦åŒ¹é…"
        }

        return error_map.get(error_code, f"æ•°æ®åº“é”™è¯¯ (ä»£ç : {error_code})")

    def close(self):
        """å…³é—­æ•°æ®åº“è¿æ¥"""
        if self.connection:
            try:
                if not self.connection._closed:  # æ£€æŸ¥è¿æ¥æ˜¯å¦å·²å…³é—­
                    self.connection.close()
                print("ğŸ”Œ æ•°æ®åº“è¿æ¥å·²å…³é—­")
            except pymysql.MySQLError as e:
                print(f"å…³é—­è¿æ¥æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            finally:
                self.connection = None

    def query(self, sql, params=None):
        """æŸ¥è¯¢æ•°æ®"""
        if not self.connection:
            print("è¯·å…ˆå»ºç«‹æ•°æ®åº“è¿æ¥")
            return None

        try:
            with self.connection.cursor() as cursor:
                cursor.execute(sql, params or ())
                result = cursor.fetchall()
                return result
        except pymysql.MySQLError as e:
            error_msg = self._interpret_error(e)
            print(f"æŸ¥è¯¢æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {error_msg}")
            print(f"SQLè¯­å¥: {sql}")
            print(f"å‚æ•°: {params}")
            return None

    def insert(self, sql, params=None):
        """æ’å…¥æ•°æ®"""
        if not self.connection:
            print("è¯·å…ˆå»ºç«‹æ•°æ®åº“è¿æ¥")
            return False, 0, ""

        try:
            with self.connection.cursor() as cursor:
                affected_rows = cursor.execute(sql, params or ())
                self.connection.commit()
                # è·å–æœ€åæ’å…¥çš„ID
                last_insert_id = cursor.lastrowid
                print(f"æˆåŠŸæ’å…¥ {affected_rows} æ¡æ•°æ®ï¼ŒID: {last_insert_id}")
                return True, affected_rows, last_insert_id
        except pymysql.MySQLError as e:
            error_msg = self._interpret_error(e)
            print(f"æ’å…¥æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {error_msg}")
            print(f"SQLè¯­å¥: {sql}")
            print(f"å‚æ•°: {params}")
            self.connection.rollback()
            return False, 0, str(e)
        except Exception as e:
            print(f"æ’å…¥æ•°æ®æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: {str(e)}")
            self.connection.rollback()
            return False, 0, str(e)

    def update(self, sql, params=None):
        """æ›´æ–°æ•°æ®"""
        if not self.connection:
            print("è¯·å…ˆå»ºç«‹æ•°æ®åº“è¿æ¥")
            return False

        try:
            with self.connection.cursor() as cursor:
                affected_rows = cursor.execute(sql, params or ())
                self.connection.commit()
                print(f"æˆåŠŸæ›´æ–° {affected_rows} æ¡æ•°æ®")
                return affected_rows > 0
        except pymysql.MySQLError as e:
            error_msg = self._interpret_error(e)
            print(f"æ›´æ–°æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {error_msg}")
            self.connection.rollback()
            return False

    def delete(self, sql, params=None):
        """åˆ é™¤æ•°æ®"""
        if not self.connection:
            print("è¯·å…ˆå»ºç«‹æ•°æ®åº“è¿æ¥")
            return False

        try:
            with self.connection.cursor() as cursor:
                affected_rows = cursor.execute(sql, params or ())
                self.connection.commit()
                print(f"æˆåŠŸåˆ é™¤ {affected_rows} æ¡æ•°æ®")
                return affected_rows > 0
        except pymysql.MySQLError as e:
            error_msg = self._interpret_error(e)
            print(f"åˆ é™¤æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {error_msg}")
            self.connection.rollback()
            return False

    def check_username_exists(self, username):
        """æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨"""
        if not self.connection:
            print("è¯·å…ˆå»ºç«‹æ•°æ®åº“è¿æ¥")
            return None

        try:
            sql = "SELECT COUNT(*) as count FROM users WHERE username = %s"
            result = self.query(sql, (username,))
            if result and len(result) > 0:
                return result[0]['count'] > 0
            return False
        except Exception as e:
            print(f"æ£€æŸ¥ç”¨æˆ·åæ—¶å‘ç”Ÿé”™è¯¯: {str(e)}")
            return None


# å¯†ç å“ˆå¸Œé…ç½®ï¼ˆå¢åŠ è‡ªåŠ¨æ£€æµ‹åç«¯ï¼‰
try:
    pwd_context = CryptContext(
        schemes=["bcrypt"],
        deprecated="auto",
        bcrypt__ident="2b"  # å…¼å®¹ä¸åŒç‰ˆæœ¬çš„bcrypt
    )
except Exception as e:
    print(f"âš ï¸ åˆå§‹åŒ–å¯†ç å“ˆå¸Œä¸Šä¸‹æ–‡å¤±è´¥: {str(e)}")
    print("å°è¯•ä½¿ç”¨å¤‡ç”¨å“ˆå¸Œæ–¹æ¡ˆ...")
    pwd_context = CryptContext(schemes=["pbkdf2_sha256"], deprecated="auto")


def verify_password(plain_password, hashed_password):
    """éªŒè¯å¯†ç ï¼Œå¢åŠ é”™è¯¯å¤„ç†"""
    try:
        return pwd_context.verify(plain_password, hashed_password)
    except Exception as e:
        print(f"å¯†ç éªŒè¯å¤±è´¥: {str(e)}")
        return False


def get_password_hash(password):
    """ç”Ÿæˆå¯†ç å“ˆå¸Œï¼Œå¢åŠ é”™è¯¯å¤„ç†"""
    try:
        return pwd_context.hash(password)
    except Exception as e:
        print(f"ç”Ÿæˆå¯†ç å“ˆå¸Œå¤±è´¥: {str(e)}")
        # ä½œä¸ºæœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼ˆä»…ç”¨äºç´§æ€¥æƒ…å†µï¼Œç”Ÿäº§ç¯å¢ƒä¸æ¨èï¼‰
        import hashlib
        return hashlib.sha256(password.encode()).hexdigest()


def create_user(db, username, password, role_id=2):
    """åˆ›å»ºæ–°ç”¨æˆ·çš„å°è£…å‡½æ•°ï¼ŒåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†"""
    # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    exists = db.check_username_exists(username)
    if exists is None:
        return False, "æ£€æŸ¥ç”¨æˆ·åå­˜åœ¨æ€§å¤±è´¥"
    if exists:
        return False, f"ç”¨æˆ·å '{username}' å·²å­˜åœ¨"

    # ç”Ÿæˆå¯†ç å“ˆå¸Œ
    password_hash = get_password_hash(password)
    if not password_hash:
        return False, "ç”Ÿæˆå¯†ç å“ˆå¸Œå¤±è´¥"

    # æ‰§è¡Œæ’å…¥æ“ä½œ
    insert_sql = """
    INSERT INTO users (username, password_hash, role_id, created_at, updated_at)
    VALUES (%s, %s, %s, NOW(), NOW())
    """

    success, rows, result = db.insert(insert_sql, (username, password_hash, role_id))
    if success:
        return True, f"ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼ŒID: {result}"
    else:
        return False, f"ç”¨æˆ·åˆ›å»ºå¤±è´¥: {result}"


def main():
    # æ•°æ®åº“é…ç½® - è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ä»¥ä¸‹å‚æ•°
    db_config = {
        "host": "62.234.187.52",  # æ•°æ®åº“IPåœ°å€
        "port": 3306,  # æ•°æ®åº“ç«¯å£
        "user": "mytest",  # æ•°æ®åº“ç”¨æˆ·å
        "password": "Test@123",  # æ•°æ®åº“å¯†ç 
        "database": "test",  # æ•°æ®åº“åç§°
        "max_retries": 3  # è¿æ¥é‡è¯•æ¬¡æ•°
    }

    # æ‰“å°å½“å‰Pythonç¯å¢ƒä¿¡æ¯
    print(f"å½“å‰Pythonç‰ˆæœ¬: {sys.version.split()[0]}")
    print(f"å½“å‰ç¯å¢ƒè·¯å¾„: {sys.executable}")

    # åˆ›å»ºæ•°æ®åº“å®ä¾‹
    db = MySQLDatabase(**db_config)

    # è¿æ¥æ•°æ®åº“
    if not db.connect():
        print("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œç¨‹åºé€€å‡º")
        return

    try:
        # 1. æŸ¥çœ‹è¡¨ç»“æ„ï¼ˆè°ƒè¯•ç”¨ï¼‰
        print("\n--- æŸ¥çœ‹usersè¡¨ç»“æ„ ---")
        table_structure = db.query("DESCRIBE users")
        if table_structure:
            for field in table_structure:
                print(field)
        else:
            print("æœªæŸ¥è¯¢åˆ°usersè¡¨ç»“æ„ï¼Œå¯èƒ½è¡¨ä¸å­˜åœ¨")
            # å°è¯•åˆ›å»ºè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            create_table_sql = """
            CREATE TABLE IF NOT EXISTS users (
                id INT AUTO_INCREMENT PRIMARY KEY,
                username VARCHAR(50) NOT NULL UNIQUE,
                password_hash VARCHAR(255) NOT NULL,
                role_id INT NOT NULL,
                created_at DATETIME NOT NULL,
                updated_at DATETIME NOT NULL,
                last_login DATETIME NULL
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
            """
            # ä½¿ç”¨queryè€Œä¸æ˜¯insertæ‰§è¡ŒCREATE TABLE
            if db.query(create_table_sql) is not None:
                print("å·²è‡ªåŠ¨åˆ›å»ºusersè¡¨")
                # åˆ›å»ºåå†æ¬¡æ£€æŸ¥è¡¨ç»“æ„
                table_structure = db.query("DESCRIBE users")
                if table_structure:
                    for field in table_structure:
                        print(field)

        # 2. æŸ¥è¯¢æ“ä½œï¼šè·å–éƒ¨åˆ†ç”¨æˆ·
        print("\n--- æŸ¥è¯¢å‰5åç”¨æˆ· ---")
        users = db.query("""
            SELECT id, username, role_id, created_at 
            FROM users 
            ORDER BY created_at DESC 
            LIMIT 5
        """)
        if users:
            for user in users:
                print(user)
        else:
            print("æœªæŸ¥è¯¢åˆ°ç”¨æˆ·æ•°æ®")

        # 3. æ’å…¥æ“ä½œï¼šæ·»åŠ æ–°ç”¨æˆ·ï¼ˆä½¿ç”¨æ”¹è¿›çš„åˆ›å»ºå‡½æ•°ï¼‰
        print("\n--- æ’å…¥æ–°ç”¨æˆ· ---")
        username = "test_user_" + str(int(time.time()))
        password = "user_password123"
        success, message = create_user(db, username, password, role_id=2)
        print(f"æ’å…¥ç»“æœ: {message}")

        if success:
            # 4. éªŒè¯å¯†ç 
            print("\n--- éªŒè¯å¯†ç  ---")
            user = db.query("SELECT * FROM users WHERE username = %s", (username,))
            if user:
                is_valid = verify_password(password, user[0]['password_hash'])
                print(f"å¯†ç éªŒè¯ç»“æœ: {'æˆåŠŸ' if is_valid else 'å¤±è´¥'}")

        # æŸ¥çœ‹æ•°æ®åº“ç‰ˆæœ¬
        print("\n--- æ•°æ®åº“ç‰ˆæœ¬ ---")
        version = db.query("SELECT VERSION()")
        if version:
            print(f"æ•°æ®åº“ç‰ˆæœ¬: {version[0]['VERSION()']}")

    except Exception as e:
        print(f"ç¨‹åºæ‰§è¡Œå‡ºé”™: {str(e)}")
        print("é”™è¯¯å †æ ˆ:")
        traceback.print_exc()  # æ‰“å°è¯¦ç»†é”™è¯¯å †æ ˆ
    finally:
        # ç¡®ä¿è¿æ¥å…³é—­
        db.close()


if __name__ == "__main__":
    main()
